kind: Template
apiVersion: v1
metadata:
  annotations:
    description: Application template for Red Hat Decision Manager Employee Rostering Optimizer 7.0 which uses an external DB.
    iconClass: icon-jboss
    tags: rhdm,jboss,xpaas
    version: "1.2"
    openshift.io/display-name: Red Hat Decision Manager Employee Rostering Optimizer 7.0 which uses an external DB
  name: rhdm70-optaweb-externaldb
labels:
  template: rhdm70-optaweb-externaldb
  rhdm: "1.2"
message: A new Business Automation Employee Rostering Optimizer application using an external DB has been created in your project. 
parameters:
- displayName: Application Name
  description: The name for the application.
  name: APPLICATION_NAME
  value: myapp
  required: true
- displayName: Employee Rostering Optimizer Custom http Route Hostname
  description: 'Custom hostname for http service route.  Leave blank for default hostname,
    e.g.: <application-name>-optaweb-<project>.<default-domain-suffix>'
  name: EXECUTION_SERVER_HOSTNAME_HTTP
  value: ''
  required: false
- displayName: ImageStream Namespace
  description: Namespace in which the ImageStreams for Red Hat Middleware images are installed. These ImageStreams are normally installed in the openshift namespace. You should only need to modify this if you've installed the ImageStreams in a different namespace/project.
  name: IMAGE_STREAM_NAMESPACE
  value: openshift
  required: true
- displayName: ImageStream Tag
  description: A named pointer to an image in an image stream. Default is "1.0".
  name: IMAGE_STREAM_TAG
  value: "1.0"
  required: false
- displayName: "Datasource Minimum Pool Size"
  description: "Sets xa-pool/min-pool-size for the configured datasource."
  name: DB_MIN_POOL_SIZE
  required: false
- displayName: "Datasource Maximum Pool Size"
  description: "Sets xa-pool/max-pool-size for the configured datasource."
  name: DB_MAX_POOL_SIZE
  required: false
- displayName: "Datasource Transaction Isolation"
  description: "Sets transaction-isolation for the configured datasource."
  name: DB_TX_ISOLATION
  required: false
- displayName: optaweb rostering persistence Dialect
  description: optaweb rostering server persistence dialect 
  name: OPTAWEB_ROSTERING_PERSISTENCE_DIALECT
  value: ''
  required: false
- displayName: optaweb rostering persistence Datasource
  description: optaweb rostering server persistence datasource for persistence.xml 
  name: OPTAWEB_ROSTERING_PERSISTENCE_DATASOURCE
  value: ''
  required: false
- description: Database name
  displayName: Database Name
  name: RHDM_DATABASE
  required: true
- description: Database user name
  displayName: Database Username
  name: RHDM_USERNAME
  required: true
- description: Database user password
  displayName: Database Password
  name: RHDM_PASSWORD
  required: true
- description: Database driver, e.g. postgresql, mysql
  displayName: Database driver
  name: RHDM_DRIVER
  required: true
  value: mysql  
- description: Database service host name
  displayName: Database service host
  name: RHDM_SERVICE_HOST
  required: true
- description: Database service port number
  displayName: Database service port
  name: RHDM_SERVICE_PORT
  required: true
- description: This parameter allows to configure datasource or xa-datasource
  displayName: Database datasource / xa-datasource
  name: NON_XA_DATASOURCE
  value: "true"
objects:
- kind: Service
  apiVersion: v1
  spec:
    ports:
    - port: 8080
      targetPort: 8080
    selector:
      deploymentConfig: "${APPLICATION_NAME}-optaweb"
  metadata:
    name: "${APPLICATION_NAME}-optaweb"
    labels:
      application: "${APPLICATION_NAME}"
    annotations:
      description: The execution server web server's http port.
- kind: Route
  apiVersion: v1
  id: "${APPLICATION_NAME}-optaweb-http"
  metadata:
    name: "${APPLICATION_NAME}-optaweb"
    labels:
      application: "${APPLICATION_NAME}"
    annotations:
      description: Route for execution server's http service.
  spec:
    host: "${EXECUTION_SERVER_HOSTNAME_HTTP}"
    to:
      name: "${APPLICATION_NAME}-optaweb"
- kind: ServiceAccount
  apiVersion: v1
  metadata:
    name: optaweb-service-account
- kind: DeploymentConfig
  apiVersion: v1
  metadata:
    name: "${APPLICATION_NAME}-optaweb"
    labels:
      application: "${APPLICATION_NAME}"
  spec:
    strategy:
      type: Recreate
    triggers:
    - type: ImageChange
      imageChangeParams:
        automatic: true
        containerNames:
        - "${APPLICATION_NAME}-optaweb"
        from:
          kind: ImageStreamTag
          namespace: "${IMAGE_STREAM_NAMESPACE}"
          name: "rhdm70-optaweb-openshift:${IMAGE_STREAM_TAG}"
    - type: ConfigChange
    replicas: 1
    selector:
      deploymentConfig: "${APPLICATION_NAME}-optaweb"
    template:
      metadata:
        name: "${APPLICATION_NAME}-optaweb"
        labels:
          deploymentConfig: "${APPLICATION_NAME}-optaweb"
          application: "${APPLICATION_NAME}"
      spec:
        serviceAccountName: optaweb-service-account
        terminationGracePeriodSeconds: 60
        containers:
        - name: "${APPLICATION_NAME}-optaweb"
          image: rhdm70-optaweb-openshift
          imagePullPolicy: Always
          livenessProbe:
            exec:
              command:
              - "/bin/bash"
              - "-c"
              - "curl --fail --silent -u '${KIE_ADMIN_USER}:${KIE_ADMIN_PWD}' http://localhost:8080/swagger/index.html"
            initialDelaySeconds: 180
            timeoutSeconds: 2
            periodSeconds: 15
          readinessProbe:
            exec:
              command:
              - "/bin/bash"
              - "-c"
              - "curl --fail --silent -u '${KIE_ADMIN_USER}:${KIE_ADMIN_PWD}' http://localhost:8080/swagger/index.html"
            initialDelaySeconds: 60
            timeoutSeconds: 2
            periodSeconds: 30
            failureThreshold: 6
          ports:
          - name: jolokia
            containerPort: 8778
            protocol: TCP
          - name: http
            containerPort: 8080
            protocol: TCP
          env:
          - name: OPTAWEB_ROSTERING_PERSISTENCE_DIALECT
            value: "${OPTAWEB_ROSTERING_PERSISTENCE_DIALECT}"
          - name: OPTAWEB_ROSTERING_PERSISTENCE_DATASOURCE
            value: "${OPTAWEB_ROSTERING_PERSISTENCE_DATASOURCE}"
          - name: DB_MIN_POOL_SIZE
            value: "${DB_MIN_POOL_SIZE}"
          - name: DB_MAX_POOL_SIZE
            value: "${DB_MAX_POOL_SIZE}"
          - name: DB_TX_ISOLATION
            value: "${DB_TX_ISOLATION}"          
          - name: DATASOURCES
            value: "RHDM"
          - name: RHDM_USERNAME
            value: "${RHDM_USERNAME}"
          - name: RHDM_PASSWORD
            value: "${RHDM_PASSWORD}"
          - name: RHDM_DATABASE
            value: "${RHDM_DATABASE}"
          - name: RHDM_DRIVER
            value: "${RHDM_DRIVER}"
          - name: RHDM_SERVICE_HOST
            value: "${RHDM_SERVICE_HOST}"
          - name: RHDM_SERVICE_PORT
            value: "${RHDM_SERVICE_PORT}"
          - name: NON_XA_DATASOURCE
            value: "${NON_XA_DATASOURCE}"


